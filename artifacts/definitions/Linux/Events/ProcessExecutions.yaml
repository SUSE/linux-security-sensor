name: Linux.Events.ProcessExecutions

description: |
  This artifact collects process execution events from the Linux audit system.

precondition: SELECT OS From info() where OS = 'linux'

type: CLIENT_EVENT

sources:
  - query: |

     LET proc_exec_rules = ("-a always,exit -F arch=b64 -S execve -k vrr_procmon", "-a always,exit -F arch=b32 -S execve -k vrr_procmon")

     LET exec_log = SELECT timestamp(string=Timestamp) AS Time, Sequence,
           atoi(string=Process.PID) AS Pid,
           atoi(string=Process.PPID) AS Ppid,
           Process.PPID AS PPID,
           atoi(string=Summary.Actor.Primary) AS UserId,
           Process.Title AS CmdLine,
           Process.Exe AS Exe,
           Process.CWD AS CWD
       FROM audit(rules=proc_exec_rules)
       WHERE "vrr_procmon" in Tags AND Result = 'success'

     LET hash_log = SELECT *,
           hash(path=Exe, hashselect=['SHA1', 'SHA256']) AS hashes
       FROM exec_log

     // Cache Uid -> Username mapping.
     LET users <= SELECT User, atoi(string=Uid) AS Uid
       FROM Artifact.Linux.Sys.Users()

     // Enrich the original artifact with more data.
     SELECT Time, Pid, Ppid, UserId,
              { SELECT User from users WHERE Uid = UserId} AS User,
              CmdLine,
              Exe, CWD,
              hashes.SHA1 AS SHA1,
              hashes.SHA256 AS SHA256
       FROM hash_log
